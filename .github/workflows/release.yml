name: ë¦´ë¦¬ì¦ˆ ìë™í™”

on:
  push:
    tags:
      - 'v*'  # v1.0.0, v1.2.3-alpha ë“± ë²„ì „ íƒœê·¸
  workflow_dispatch:
    inputs:
      version:
        description: 'ë¦´ë¦¬ì¦ˆ ë²„ì „ (ì˜ˆ: v1.0.0)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  FRONTEND_IMAGE: ${{ github.repository }}-frontend
  BACKEND_IMAGE: ${{ github.repository }}-backend

jobs:
  build-and-test:
    name: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ë²„ì „ ì¶”ì¶œ
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION=${{ github.event.inputs.version }}
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "ë¦´ë¦¬ì¦ˆ ë²„ì „: ${VERSION}"
    
    # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '24.7.0'
        cache: 'yarn'
        cache-dependency-path: frontend/yarn.lock
        
    - name: í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: ./frontend
      run: yarn install --frozen-lockfile
      
    - name: í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸
      working-directory: ./frontend
      run: yarn test --run
      
    - name: í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡œë•ì…˜ ë¹Œë“œ
      working-directory: ./frontend
      run: yarn build
      
    # ë°±ì—”ë“œ ë¹Œë“œ
    - name: Java 24 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '24'
        distribution: 'temurin'
        
    - name: Gradle ìºì‹œ ì„¤ì •
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      working-directory: ./backend
      run: chmod +x gradlew
      
    - name: ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸
      working-directory: ./backend
      run: ./gradlew test
      
    - name: ë°±ì—”ë“œ ë¹Œë“œ
      working-directory: ./backend
      run: ./gradlew build -x test
      
    # ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
    - name: í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: frontend/dist/
        
    - name: ë°±ì—”ë“œ JAR íŒŒì¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: backend-jar
        path: backend/build/libs/*.jar

  docker-build:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: read
      packages: write
    
    strategy:
      matrix:
        component: [frontend, backend]
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ë¹Œë“œ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v4
      with:
        name: ${{ matrix.component }}-${{ matrix.component == 'frontend' && 'dist' || 'jar' }}
        path: ${{ matrix.component }}/
        
    - name: Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@988b5a0280414f521da01fcc63a27aeeb4b104db
      
    - name: GitHub Container Registry ë¡œê·¸ì¸
      uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
      id: meta
      uses: docker/metadata-action@8e5442c4ef9f78752691e2d8f8d19755c6f78e81
      with:
        images: ${{ env.REGISTRY }}/${{ matrix.component == 'frontend' && env.FRONTEND_IMAGE || env.BACKEND_IMAGE }}
        tags: |
          type=ref,event=tag
          type=raw,value=latest
          type=raw,value=${{ needs.build-and-test.outputs.version }}
          
    - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25
      with:
        context: ${{ matrix.component }}
        file: ${{ matrix.component }}/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  create-release:
    name: GitHub ë¦´ë¦¬ì¦ˆ ìƒì„±
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build]
    permissions:
      contents: write
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ë¹Œë“œ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v4
      with:
        pattern: "*"
        merge-multiple: true
        path: ./artifacts/
        
    - name: ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
      id: release-notes
      run: |
        VERSION="${{ needs.build-and-test.outputs.version }}"
        
        # ì´ì „ íƒœê·¸ ì°¾ê¸°
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        echo "## ğŸš€ ë¦´ë¦¬ì¦ˆ ${VERSION}" > RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        
        if [ -n "$PREV_TAG" ]; then
          echo "### ğŸ“‹ ë³€ê²½ì‚¬í•­" >> RELEASE_NOTES.md
          git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" >> RELEASE_NOTES.md
        else
          echo "### ğŸ“‹ ë³€ê²½ì‚¬í•­" >> RELEASE_NOTES.md
          echo "- ì´ˆê¸° ë¦´ë¦¬ì¦ˆ" >> RELEASE_NOTES.md
        fi
        
        echo "" >> RELEASE_NOTES.md
        echo "### ğŸ³ Docker ì´ë¯¸ì§€" >> RELEASE_NOTES.md
        echo "- **í”„ë¡ íŠ¸ì—”ë“œ**: \`${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${VERSION}\`" >> RELEASE_NOTES.md
        echo "- **ë°±ì—”ë“œ**: \`${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${VERSION}\`" >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "### ğŸ“¦ ì•„í‹°íŒ©íŠ¸" >> RELEASE_NOTES.md
        echo "- í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ë¬¼" >> RELEASE_NOTES.md
        echo "- ë°±ì—”ë“œ JAR íŒŒì¼" >> RELEASE_NOTES.md
        
        # íŒŒì¼ì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì „ë‹¬
        echo 'RELEASE_BODY<<EOF' >> $GITHUB_ENV
        cat RELEASE_NOTES.md >> $GITHUB_ENV
        echo 'EOF' >> $GITHUB_ENV
        
    - name: ZIP íŒŒì¼ ìƒì„±
      run: |
        cd artifacts
        zip -r ../frontend-${{ needs.build-and-test.outputs.version }}.zip dist/ || true
        zip -r ../backend-${{ needs.build-and-test.outputs.version }}.zip *.jar || true
        cd ..
        
    - name: GitHub ë¦´ë¦¬ì¦ˆ ìƒì„±
      uses: softprops/action-gh-release@26994186c0ac3ef5cae75ac16aa32e8153525f77
      with:
        tag_name: ${{ needs.build-and-test.outputs.version }}
        name: Release ${{ needs.build-and-test.outputs.version }}
        body: ${{ env.RELEASE_BODY }}
        draft: false
        prerelease: ${{ contains(needs.build-and-test.outputs.version, 'alpha') || contains(needs.build-and-test.outputs.version, 'beta') || contains(needs.build-and-test.outputs.version, 'rc') }}
        files: |
          frontend-${{ needs.build-and-test.outputs.version }}.zip
          backend-${{ needs.build-and-test.outputs.version }}.zip

  notify:
    name: ë¦´ë¦¬ì¦ˆ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [build-and-test, create-release]
    if: always()
    
    steps:
    - name: ë¦´ë¦¬ì¦ˆ ì™„ë£Œ ì•Œë¦¼
      run: |
        if [ "${{ needs.create-release.result }}" = "success" ]; then
          echo "ğŸ‰ ë¦´ë¦¬ì¦ˆ ${{ needs.build-and-test.outputs.version }} ì´/ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“¦ GitHub ë¦´ë¦¬ì¦ˆ: https://github.com/${{ github.repository }}/releases/tag/${{ needs.build-and-test.outputs.version }}"
          echo "ğŸ³ Docker ì´ë¯¸ì§€:"
          echo "  - ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ needs.build-and-test.outputs.version }}"
          echo "  - ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ needs.build-and-test.outputs.version }}"
        else
          echo "âŒ ë¦´ë¦¬ì¦ˆ ${{ needs.build-and-test.outputs.version }} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
        fi