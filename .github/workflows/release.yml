name: ë¦´ë¦¬ì¦ˆ ìë™í™”

on:
  push:
    tags:
      - 'v*'  # v1.0.0, v1.2.3-alpha ë“± ë²„ì „ íƒœê·¸
  workflow_dispatch:
    inputs:
      version:
        description: 'ë¦´ë¦¬ì¦ˆ ë²„ì „ (ì˜ˆ: v1.0.0)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  FRONTEND_IMAGE: ${{ github.repository }}-frontend
  BACKEND_IMAGE: ${{ github.repository }}-backend

jobs:
  build-and-test:
    name: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v5
      
    - name: ë²„ì „ ì¶”ì¶œ
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION=${{ github.event.inputs.version }}
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "ë¦´ë¦¬ì¦ˆ ë²„ì „: ${VERSION}"
    
    # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v5
      with:
        node-version: '24.7.0'
        cache: 'yarn'
        cache-dependency-path: frontend/yarn.lock
        
    - name: í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: ./frontend
      run: yarn install --frozen-lockfile
      
    - name: í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸
      working-directory: ./frontend
      run: yarn test --run
      
    - name: í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡œë•ì…˜ ë¹Œë“œ
      working-directory: ./frontend
      run: yarn build
      
    # ë°±ì—”ë“œ ë¹Œë“œ
    - name: Java 24 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '24'
        distribution: 'temurin'
        
    - name: Gradle ìºì‹œ ì„¤ì •
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      working-directory: ./backend
      run: chmod +x gradlew
      
    - name: ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸
      working-directory: ./backend
      run: ./gradlew test
      
    - name: ë°±ì—”ë“œ ë¹Œë“œ
      working-directory: ./backend
      run: ./gradlew build -x test
      
    # ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
    - name: í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: frontend/dist/
        
    - name: ë°±ì—”ë“œ JAR íŒŒì¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: backend-jar
        path: backend/build/libs/*.jar

  docker-build:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: read
      packages: write
    
    strategy:
      matrix:
        component: [frontend, backend]
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v5
      
    - name: ë¹Œë“œ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v5
      with:
        name: ${{ matrix.component }}-${{ matrix.component == 'frontend' && 'dist' || 'jar' }}
        path: ${{ matrix.component }}/
        
    - name: JAR íŒŒì¼ëª… ì°¾ê¸° (ë°±ì—”ë“œ)
      if: matrix.component == 'backend'
      id: jar-name
      working-directory: ${{ matrix.component }}
      run: |
        JAR_FILE=$(ls *.jar | grep -v plain | head -1)
        echo "jar_file=${JAR_FILE}" >> $GITHUB_OUTPUT
        echo "ì°¾ì€ JAR íŒŒì¼: ${JAR_FILE}"
        
    - name: Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435
      
    - name: GitHub Container Registry ë¡œê·¸ì¸
      uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
      id: meta
      uses: docker/metadata-action@8e5442c4ef9f78752691e2d8f8d19755c6f78e81
      with:
        images: ${{ env.REGISTRY }}/${{ matrix.component == 'frontend' && env.FRONTEND_IMAGE || env.BACKEND_IMAGE }}
        tags: |
          type=ref,event=tag
          type=raw,value=latest
          type=raw,value=${{ needs.build-and-test.outputs.version }}
          
    - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25
      with:
        context: ${{ matrix.component }}
        file: ${{ matrix.component }}/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          ${{ matrix.component == 'backend' && format('JAR_FILE={0}', steps.jar-name.outputs.jar_file) || '' }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  create-release:
    name: GitHub ë¦´ë¦¬ì¦ˆ ìƒì„±
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build]
    permissions:
      contents: write
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        
    - name: í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v5
      with:
        name: frontend-dist
        path: ./artifacts/frontend/
        
    - name: ë°±ì—”ë“œ JAR íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v5
      with:
        name: backend-jar
        path: ./artifacts/backend/
        
    - name: ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
      id: release-notes
      run: |
        VERSION="${{ needs.build-and-test.outputs.version }}"
        
        # ì´ì „ íƒœê·¸ ì°¾ê¸°
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        echo "## ğŸš€ ë¦´ë¦¬ì¦ˆ ${VERSION}" > RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        
        if [ -n "$PREV_TAG" ]; then
          echo "### ğŸ“‹ ë³€ê²½ì‚¬í•­" >> RELEASE_NOTES.md
          git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" >> RELEASE_NOTES.md
        else
          echo "### ğŸ“‹ ë³€ê²½ì‚¬í•­" >> RELEASE_NOTES.md
          echo "- ì´ˆê¸° ë¦´ë¦¬ì¦ˆ" >> RELEASE_NOTES.md
        fi
        
        echo "" >> RELEASE_NOTES.md
        echo "### ğŸ³ Docker ì´ë¯¸ì§€" >> RELEASE_NOTES.md
        echo "- **í”„ë¡ íŠ¸ì—”ë“œ**: \`${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${VERSION}\`" >> RELEASE_NOTES.md
        echo "- **ë°±ì—”ë“œ**: \`${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${VERSION}\`" >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "### ğŸ“¦ ì•„í‹°íŒ©íŠ¸" >> RELEASE_NOTES.md
        echo "- í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ë¬¼" >> RELEASE_NOTES.md
        echo "- ë°±ì—”ë“œ JAR íŒŒì¼" >> RELEASE_NOTES.md
        
        # íŒŒì¼ì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì „ë‹¬
        echo 'RELEASE_BODY<<EOF' >> $GITHUB_ENV
        cat RELEASE_NOTES.md >> $GITHUB_ENV
        echo 'EOF' >> $GITHUB_ENV
        
    - name: ì•„í‹°íŒ©íŠ¸ êµ¬ì¡° í™•ì¸ ë° ZIP íŒŒì¼ ìƒì„±
      run: |
        VERSION="${{ needs.build-and-test.outputs.version }}"
        echo "=== ì•„í‹°íŒ©íŠ¸ ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸ ==="
        find ./artifacts -type f -ls || echo "ì•„í‹°íŒ©íŠ¸ ë””ë ‰í† ë¦¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤"
        
        echo "=== ZIP íŒŒì¼ ìƒì„± ì‹œì‘ ==="
        
        # í”„ë¡ íŠ¸ì—”ë“œ ZIP ìƒì„±
        if [ -d "./artifacts/frontend" ] && [ "$(find ./artifacts/frontend -type f | wc -l)" -gt 0 ]; then
          cd ./artifacts/frontend
          zip -r "../../frontend-${VERSION}.zip" . -x "*.zip"
          cd ../..
          echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ZIP ìƒì„± ì™„ë£Œ: frontend-${VERSION}.zip"
        else
          echo "âš ï¸  í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ì´ ì—†ì–´ì„œ ZIP ìƒì„±ì„ ê±´ë„ˆëœë‹ˆë‹¤"
          touch "frontend-${VERSION}.zip"  # ë¹ˆ íŒŒì¼ ìƒì„±í•˜ì—¬ ì—ëŸ¬ ë°©ì§€
        fi
        
        # ë°±ì—”ë“œ ZIP ìƒì„±
        if [ -d "./artifacts/backend" ] && [ "$(find ./artifacts/backend -name '*.jar' | wc -l)" -gt 0 ]; then
          cd ./artifacts/backend
          zip -r "../../backend-${VERSION}.zip" *.jar
          cd ../..
          echo "âœ… ë°±ì—”ë“œ ZIP ìƒì„± ì™„ë£Œ: backend-${VERSION}.zip"
        else
          echo "âš ï¸  ë°±ì—”ë“œ JAR íŒŒì¼ì´ ì—†ì–´ì„œ ZIP ìƒì„±ì„ ê±´ë„ˆëœë‹ˆë‹¤"
          touch "backend-${VERSION}.zip"  # ë¹ˆ íŒŒì¼ ìƒì„±í•˜ì—¬ ì—ëŸ¬ ë°©ì§€
        fi
        
        echo "=== ìƒì„±ëœ ZIP íŒŒì¼ í™•ì¸ ==="
        ls -la *.zip || echo "ZIP íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
        
    - name: ê¸°ì¡´ ë¦´ë¦¬ì¦ˆ í™•ì¸ ë° ì •ë¦¬
      run: |
        VERSION="${{ needs.build-and-test.outputs.version }}"
        echo "ë²„ì „ ${VERSION}ì˜ ê¸°ì¡´ ë¦´ë¦¬ì¦ˆ í™•ì¸ ì¤‘..."
        
        # GitHub CLIë¡œ ê¸°ì¡´ ë¦´ë¦¬ì¦ˆ í™•ì¸
        if gh release view "${VERSION}" --json tagName > /dev/null 2>&1; then
          echo "âš ï¸  ê¸°ì¡´ ë¦´ë¦¬ì¦ˆ ${VERSION}ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ì‚­ì œ ì¤‘..."
          gh release delete "${VERSION}" --yes || echo "ë¦´ë¦¬ì¦ˆ ì‚­ì œ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ê³„ì†)"
        else
          echo "âœ… ${VERSION} ë¦´ë¦¬ì¦ˆê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        fi
        
        # ê¸°ì¡´ íƒœê·¸ë„ í™•ì¸í•˜ê³  ì‚­ì œ
        if git tag -l | grep -q "^${VERSION}$"; then
          echo "âš ï¸  ê¸°ì¡´ íƒœê·¸ ${VERSION}ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ì‚­ì œ ì¤‘..."
          git tag -d "${VERSION}" || echo "ë¡œì»¬ íƒœê·¸ ì‚­ì œ ì‹¤íŒ¨"
          git push origin ":refs/tags/${VERSION}" || echo "ì›ê²© íƒœê·¸ ì‚­ì œ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ê³„ì†)"
        else
          echo "âœ… ${VERSION} íƒœê·¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ZIP íŒŒì¼ ì¡´ì¬ í™•ì¸
      run: |
        VERSION="${{ needs.build-and-test.outputs.version }}"
        echo "=== ë¦´ë¦¬ì¦ˆì— í¬í•¨í•  íŒŒì¼ ëª©ë¡ í™•ì¸ ==="
        
        RELEASE_FILES=""
        
        if [ -f "frontend-${VERSION}.zip" ] && [ -s "frontend-${VERSION}.zip" ]; then
          echo "âœ… frontend-${VERSION}.zip íŒŒì¼ í™•ì¸ë¨ ($(du -h "frontend-${VERSION}.zip" | cut -f1))"
          RELEASE_FILES="frontend-${VERSION}.zip"
        else
          echo "âš ï¸  frontend-${VERSION}.zip íŒŒì¼ì´ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤"
        fi
        
        if [ -f "backend-${VERSION}.zip" ] && [ -s "backend-${VERSION}.zip" ]; then
          echo "âœ… backend-${VERSION}.zip íŒŒì¼ í™•ì¸ë¨ ($(du -h "backend-${VERSION}.zip" | cut -f1))"
          RELEASE_FILES="${RELEASE_FILES} backend-${VERSION}.zip"
        else
          echo "âš ï¸  backend-${VERSION}.zip íŒŒì¼ì´ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤"
        fi
        
        echo "RELEASE_FILES=${RELEASE_FILES}" >> $GITHUB_ENV
        echo "ë¦´ë¦¬ì¦ˆì— í¬í•¨ë  íŒŒì¼: ${RELEASE_FILES}"
        
    - name: GitHub ë¦´ë¦¬ì¦ˆ ìƒì„±
      uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844
      with:
        tag_name: ${{ needs.build-and-test.outputs.version }}
        name: Release ${{ needs.build-and-test.outputs.version }}
        body: ${{ env.RELEASE_BODY }}
        draft: false
        prerelease: ${{ contains(needs.build-and-test.outputs.version, 'alpha') || contains(needs.build-and-test.outputs.version, 'beta') || contains(needs.build-and-test.outputs.version, 'rc') }}
        files: ${{ env.RELEASE_FILES }}

  notify:
    name: ë¦´ë¦¬ì¦ˆ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [build-and-test, create-release]
    if: always()
    
    steps:
    - name: ë¦´ë¦¬ì¦ˆ ì™„ë£Œ ì•Œë¦¼
      run: |
        if [ "${{ needs.create-release.result }}" = "success" ]; then
          echo "ğŸ‰ ë¦´ë¦¬ì¦ˆ ${{ needs.build-and-test.outputs.version }} ì´/ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“¦ GitHub ë¦´ë¦¬ì¦ˆ: https://github.com/${{ github.repository }}/releases/tag/${{ needs.build-and-test.outputs.version }}"
          echo "ğŸ³ Docker ì´ë¯¸ì§€:"
          echo "  - ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ needs.build-and-test.outputs.version }}"
          echo "  - ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ needs.build-and-test.outputs.version }}"
        else
          echo "âŒ ë¦´ë¦¬ì¦ˆ ${{ needs.build-and-test.outputs.version }} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
        fi